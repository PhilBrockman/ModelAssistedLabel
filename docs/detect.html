---

title: Detecting Objects


keywords: fastai
sidebar: home_sidebar

summary: "wrapping `detect.py`"
description: "wrapping `detect.py`"
nb_path: "03_detect.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: 03_detect.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%</span><span class="k">run</span> &quot;_Synch.ipynb&quot;
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Drive already mounted at /content/drive; to attempt to forcibly remount, call drive.mount(&#34;/content/drive&#34;, force_remount=True).
/content/drive/MyDrive/Coding/ModelAssistedLabel
install nbdev: 
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="Detector" class="doc_header"><code>class</code> <code>Detector</code><a href="https://github.com/PhilBrockman/ModelAssistedLabel/tree/master/ModelAssistedLabel/detect.py#L22" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>Detector</code>(<strong><code>weight_path</code></strong>, <strong><code>conf_threshold</code></strong>=<em><code>0.4</code></em>, <strong><code>iou_threshold</code></strong>=<em><code>0.45</code></em>, <strong><code>imgsz</code></strong>=<em><code>416</code></em>, <strong><code>save_dir</code></strong>=<em><code>'save_dir'</code></em>, <strong><code>save_labeled_img</code></strong>=<em><code>True</code></em>, <strong><code>save_unscuffed</code></strong>=<em><code>True</code></em>)</p>
</blockquote>
<p>A wrapper for training loading saved YOLOv5 weights</p>
<p>requirements:
  GPU enabled</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="ImageProcessor" class="doc_header"><code>class</code> <code>ImageProcessor</code><a href="https://github.com/PhilBrockman/ModelAssistedLabel/tree/master/ModelAssistedLabel/detect.py#L157" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>ImageProcessor</code>(<strong><code>with_weights</code></strong>, <strong><code>save_labeled_img</code></strong>=<em><code>False</code></em>, <strong><code>save_unscuffed</code></strong>=<em><code>False</code></em>, <strong><code>data_yaml</code></strong>=<em><code>None</code></em>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">ip</span> <span class="o">=</span> <span class="n">ImageProcessor</span><span class="p">(</span><span class="n">with_weights</span><span class="o">=</span><span class="s2">&quot;pre-trained YOLOv5 weights/21-2-25 1k-digits YOLOv5-weights.pt&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>Fusing layers... 
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="o">%%</span><span class="k">time</span>
ip.process_new_images(folder_path=&quot;Image Repo/unlabeled/21-3-18 rowing 8-12 /&quot;)
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>CPU times: user 7.53 s, sys: 320 ms, total: 7.85 s
Wall time: 8.39 s
</pre>
</div>
</div>

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>200</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="resolving-conflicts">resolving conflicts<a class="anchor-link" href="#resolving-conflicts"> </a></h1><blockquote><p>overlapping bounding boxes</p>
</blockquote>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="yoloBox_to_standard" class="doc_header"><code>yoloBox_to_standard</code><a href="https://github.com/PhilBrockman/ModelAssistedLabel/tree/master/ModelAssistedLabel/detect.py#L188" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>yoloBox_to_standard</code>(<strong><code>result</code></strong>)</p>
</blockquote>
<p>The standard YOLOv5 coordinate format is normed to 1. Need to extract the
original's image width and height to convert to a standard cartesian plane.</p>
<p>Args:
  result: a dictionary that includes both</p>

<pre><code>  * a key called "filename" that points to the original image
  * a key called "predictions" created when the image is parsed with the
    YOLOv5 model

</code></pre>
<p>Returns:
  Convert the predictions converted to a full-scale Cartesian coordinate system.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="bb_intersection_over_union" class="doc_header"><code>bb_intersection_over_union</code><a href="https://github.com/PhilBrockman/ModelAssistedLabel/tree/master/ModelAssistedLabel/detect.py#L223" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>bb_intersection_over_union</code>(<strong><code>boxA</code></strong>, <strong><code>boxB</code></strong>)</p>
</blockquote>
<p>Source: <a href="https://www.pyimagesearch.com/2016/11/07/intersection-over-union-iou-for-object-detection/">https://www.pyimagesearch.com/2016/11/07/intersection-over-union-iou-for-object-detection/</a></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="sorted_api" class="doc_header"><code>sorted_api</code><a href="https://github.com/PhilBrockman/ModelAssistedLabel/tree/master/ModelAssistedLabel/detect.py#L248" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>sorted_api</code>(<strong><code>predictions</code></strong>)</p>
</blockquote>
<p>sorts a list of prediction in ascending x order</p>
<p>Args:
  an array of dictionaries containing bbox predictions</p>
<p>Returns:
  the bounding boxes read off from left to right</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="digit_arr_to_string" class="doc_header"><code>digit_arr_to_string</code><a href="https://github.com/PhilBrockman/ModelAssistedLabel/tree/master/ModelAssistedLabel/detect.py#L258" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>digit_arr_to_string</code>(<strong><code>predictions</code></strong>)</p>
</blockquote>
<p>"Human-friendly interpretation of predictions</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="corners" class="doc_header"><code>corners</code><a href="https://github.com/PhilBrockman/ModelAssistedLabel/tree/master/ModelAssistedLabel/detect.py#L263" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>corners</code>(<strong><code>r</code></strong>)</p>
</blockquote>
<p>Defines the relevante coordinate information</p>
<p>Args:
  r: converts a DataFrame row to a tuple</p>
<p>Returns:
  Caretensian coordinate information (anchor in the lower left)</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="calculate_iou" class="doc_header"><code>calculate_iou</code><a href="https://github.com/PhilBrockman/ModelAssistedLabel/tree/master/ModelAssistedLabel/detect.py#L275" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>calculate_iou</code>(<strong><code>frame</code></strong>, <strong><code>threshold</code></strong>=<em><code>0.4</code></em>)</p>
</blockquote>
<p>Determines the pair of bounding boxes that has the highest IoU over the :threshold:</p>
<p>Args:
  frame: the output of either a YOLOv5 model call or an API call
  threshold: maximum percentage of overlap allowed between the bounding boxes</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>{% include note.html content='the following functions work together to form the core of parsing bounding' %}box information.
{% include warning.html content='I assume that screens have no more than 4 objects in them.' %}
If extra bounding boxesare detected, I find the pair of boxes that has the highest IoU (Intersection 
over Union). Of that pair, I identify the box that has the a lower associated
confidence and remove it.</p>
<p>If there is still an excess of bounding boxes but no boxes that are overlapping
in excess of the :threshold:, then bounding boxes with the most deviated y are 
removed</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">interpret_predictions</span><span class="p">(</span><span class="n">predictions_arr</span><span class="p">):</span>
  <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">predictions_arr</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">predictions_arr</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">remove_worst</span><span class="p">(</span><span class="n">predictions_arr</span><span class="p">)):</span>
    <span class="n">predictions_arr</span> <span class="o">=</span> <span class="n">remove_worst</span><span class="p">(</span><span class="n">predictions_arr</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">predictions_arr</span>

<span class="k">def</span> <span class="nf">remove_worst_offender</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">threshold</span><span class="p">):</span>
  <span class="n">overlappers</span> <span class="o">=</span> <span class="n">calculate_iou</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
  
  <span class="k">if</span> <span class="n">overlappers</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">included</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">res</span> <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;index&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">overlappers</span><span class="p">[</span><span class="s2">&quot;least confident&quot;</span><span class="p">][</span><span class="s2">&quot;index&quot;</span><span class="p">]]</span>
    <span class="k">return</span> <span class="n">included</span>
  <span class="k">else</span><span class="p">:</span> <span class="c1">#look for y outlier</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
    <span class="c1"># print(df.sort_values(by=&quot;confidence&quot;,ascending=False))</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;zscore&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">y</span> <span class="o">-</span> <span class="n">df</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span><span class="o">/</span><span class="n">df</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="c1">#FIXME</span>
    <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;zscore&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">1.5</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="s1">&#39;records&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">remove_worst</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=.</span><span class="mi">4</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">remove_worst_offender</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">threshold</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="post-processing">post-processing<a class="anchor-link" href="#post-processing"> </a></h3>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="raw_parse_from_json" class="doc_header"><code>raw_parse_from_json</code><a href="https://github.com/PhilBrockman/ModelAssistedLabel/tree/master/ModelAssistedLabel/detect.py#L308" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>raw_parse_from_json</code>(<strong><code>json_elements</code></strong>, <strong><code>loaded_detector</code></strong>)</p>
</blockquote>
<p>Helper to interpret raw base 64 images. Creates a new JPG file from the base64
data and feeds the image to the Detector</p>
<p>Args:
  json_elements: array of dictionaries from file. Assert existence of a "base64"
    key where the images are stored
  loaded_detector: a valid Detector</p>
<p>returns:
  the result of processessing all of the base64 images</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="parse_from_json" class="doc_header"><code>parse_from_json</code><a href="https://github.com/PhilBrockman/ModelAssistedLabel/tree/master/ModelAssistedLabel/detect.py#L333" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>parse_from_json</code>(<strong><code>json_elements</code></strong>, <strong><code>loaded_detector</code></strong>)</p>
</blockquote>
<p>Gets a JSON file containing the base64 images of data to label pushed through
a Detector. Post-processing automatically de-norms the YOLOv5 bounding boxes
based on the original image's height and width</p>
<p>Args:
  json_elements: array of dictionaries from file. Assert existence of a "base64"
    key where the images are stored
  loaded_detector: a valid Detector</p>
<p>returns:
  the bounding boxes associated with each image</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

</div>
 

